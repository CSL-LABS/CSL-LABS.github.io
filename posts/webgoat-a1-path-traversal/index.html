<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="WebGoat - A1 - Path Traversal" /><meta name="author" content="Christian Gutierrez" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introducción De forma breve, como lo indica la descripción de la vulnerabilidad el Path Traversal nos permite crear, leer, editar o eliminar archivos fuera la ubicación definida por el aplicativo; Algunos posibles escenarios de explotación son los siguientes:" /><meta property="og:description" content="Introducción De forma breve, como lo indica la descripción de la vulnerabilidad el Path Traversal nos permite crear, leer, editar o eliminar archivos fuera la ubicación definida por el aplicativo; Algunos posibles escenarios de explotación son los siguientes:" /><link rel="canonical" href="https://csl-labs.github.io/posts/webgoat-a1-path-traversal/" /><meta property="og:url" content="https://csl-labs.github.io/posts/webgoat-a1-path-traversal/" /><meta property="og:site_name" content="CSL" /><meta property="og:image" content="https://csl-labs.github.io/assets/webgoat/A1/3_path_traversal/portada.PNG" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-07T14:10:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://csl-labs.github.io/assets/webgoat/A1/3_path_traversal/portada.PNG" /><meta property="twitter:title" content="WebGoat - A1 - Path Traversal" /><meta name="twitter:site" content="@CsLcol" /><meta name="twitter:creator" content="@Christian Gutierrez" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"image":"https://csl-labs.github.io/assets/webgoat/A1/3_path_traversal/portada.PNG","description":"Introducción De forma breve, como lo indica la descripción de la vulnerabilidad el Path Traversal nos permite crear, leer, editar o eliminar archivos fuera la ubicación definida por el aplicativo; Algunos posibles escenarios de explotación son los siguientes:","mainEntityOfPage":{"@type":"WebPage","@id":"https://csl-labs.github.io/posts/webgoat-a1-path-traversal/"},"@type":"BlogPosting","url":"https://csl-labs.github.io/posts/webgoat-a1-path-traversal/","headline":"WebGoat - A1 - Path Traversal","dateModified":"2021-01-07T14:10:00-05:00","datePublished":"2021-01-07T14:10:00-05:00","author":{"@type":"Person","name":"Christian Gutierrez"},"@context":"https://schema.org"}</script><title>WebGoat - A1 - Path Traversal | CSL</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/base/logoCSL.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">CSL</a></div><div class="site-subtitle font-italic">WriteUps, HackTheBox, CTF's, CheatSheet, Wargames & more...</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>NOSOTROS</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/csl-labs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/CsLcol" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['csl','csl.com.co'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Publicaciones </a> </span> <span>WebGoat - A1 - Path Traversal</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Buscador..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>WebGoat - A1 - Path Traversal</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jan 7, 2021, 2:10 PM -0500" > Jan 7 <i class="unloaded">2021-01-07T14:10:00-05:00</i> </span> by <span class="author"> Christian Gutierrez </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/portada.PNG" class="post-preview-img"><h2 id="introducción">Introducción</h2><p>De forma breve, como lo indica la descripción de la vulnerabilidad el <strong>Path Traversal</strong> nos permite crear, leer, editar o eliminar archivos fuera la ubicación definida por el aplicativo; Algunos posibles escenarios de explotación son los siguientes:</p><ul><li><strong>Enumeración de archivos internos</strong>:<ul><li>Pensemos en un aplicativo que retorna un mensaje de existencia como <em>“No es posible leer el archivo”</em> cada vez que se intenta crear un archivo en una ruta por ejemplo como: <code class="language-plaintext highlighter-rouge">../../ultra_secreto.txt</code>, esto nos permite realizar ataques por diccionario con nombres comunes de archivos, alternando entre directorios <code class="language-plaintext highlighter-rouge">../</code> y permitiendo por medio de la respuesta identificar cuales existen.</ul><li><strong>Sobrescribir un archivo interno</strong>:<ul><li>La manera más directa es cuando además de la ruta de creación, también controlamos el nombre con el que se almacena el archivo, por lo que podemos sobrescribir componentes internos; un ejemplo sería identificar la ruta del <code class="language-plaintext highlighter-rouge">index.php</code> y resubir un archivo con el mismo nombre <code class="language-plaintext highlighter-rouge">../../index.php</code> y que en su contenido se incluya algún tipo de sniffer para el formulario login.</ul><li><strong>Eliminar un archivo interno</strong>:<ul><li>Evidentemente, si podemos sobrescribir un archivo podemos eliminarlo o llevar su contenido a <strong>“vacio”</strong>, posibilitando la eliminación de componentes de seguridad o de core que afecten el aplicativo. Un caso sería cuando se controla la ruta y el nombre, pero existe un filtro de contenido que evita la inclusión de código malicioso, se puede inyectar un archivo vacio o con información basura.</ul><li><strong>Lectura de archivos internos</strong>:<ul><li>Manipulando las rutas mediante los saltos de directorio <code class="language-plaintext highlighter-rouge">../</code> y <code class="language-plaintext highlighter-rouge">..\</code> en una funcionalidad de lectura, es posible acceder al contenido de archivos internos de alta criticidad, como por ejemplo: <strong>web.config</strong>, <strong>.htaccess</strong>, <strong>config.php</strong>, <strong>wp-config.php</strong>, etc…</ul></ul><h2 id="path-traversal---2">Path Traversal - #2</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/01_ejercicio_2.png" alt="Ejercicio #2" /> <em>Ejercicio #2</em></p><p>Se tiene un formulario común de actualización de perfil de usuario, en el que se puede subir una <strong>imagen/foto/avatar</strong>, y además se indican 3 parametros a rellenar, que vistos desde la herramienta ```BurpSuite``, se envian al aplicativo los siguientes datos:</p><ul><li><code class="language-plaintext highlighter-rouge">uploadFile</code><li><code class="language-plaintext highlighter-rouge">fullName</code><li><code class="language-plaintext highlighter-rouge">email</code><li><code class="language-plaintext highlighter-rouge">password</code></ul><blockquote><p>Como consejo general, se recomienda primero ver el comportamiento de las funcionalidades, la información enviada y la información que se recibe para tomarlo como base y así identificar de forma sencilla cambios o comportamientos que se enlazan a los ataques que inyectamos.</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/01_paquete_inicial.png" alt="Respuesta Inicial" /> <em>Respuesta Inicial</em></p><p>Para este ejemplo se ingreso como nombre <strong>test</strong> y de la respuesta se pueden deducir varias cosas:</p><ol><li>El archivo se almacenará bajo el nombre agregado en el parámetro <code class="language-plaintext highlighter-rouge">fullName</code>.<li>Aunque inicialmente se almacena <strong>sin</strong> una extensión, se puede agregar en el <code class="language-plaintext highlighter-rouge">fullName</code>.<li>No hay un filtro ni alguna regla que nos obligue a subir únicamente archivos de tipo <strong>IMAGEN</strong> o algo particular.</ol><p>Teniendo lo anterior en mente, se realiza la prueba básica de agregar al futuro nombre el archivo un salto de directorio <code class="language-plaintext highlighter-rouge">../</code> y comprobar si la aplicación fija los archivos a un directorio destino o si el aplicativo cuenta con filtros de este tipo de caracteres:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/01_vulnerabilidad_pasada.png" alt="Reto Superado" /> <em>Reto Superado</em></p><p>Como se observa de la respuesta, hemos pasado el reto ;)… sin embargo, veamos a nivel de código qué sucede:</p><ul><li><a href="https://github.com/WebGoat/WebGoat/tree/develop/webgoat-lessons/path-traversal/src/main/java/org/owasp/webgoat/path_traversal"><strong>Código base de la lección Path Traversal</strong></a></ul><p>Veremos únicamente el código afectado, pero puedes profundizar en el enlace anterior, accedienco a <code class="language-plaintext highlighter-rouge">ProfileUploadBase.java</code>.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/PathTraversal/profile-upload"</span><span class="o">,</span> <span class="n">consumes</span> <span class="o">=</span> <span class="no">ALL_VALUE</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="no">APPLICATION_JSON_VALUE</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">AttackResult</span> <span class="nf">uploadFileHandler</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"uploadedFile"</span><span class="o">)</span> <span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">,</span> <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"fullName"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">fullName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">fullName</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Como se observa solo se requieren los parametros <code class="language-plaintext highlighter-rouge">uploadedFile</code> y <code class="language-plaintext highlighter-rouge">fullName</code>, los cuales no tienen ningún proceso de filtrado o saneamiento, estos se pasan directamente a la funcionalidad <a href="https://github.com/WebGoat/WebGoat/blob/60c7fdd0dbcbc09aaa22f5c772666c716344f8cf/webgoat-lessons/path-traversal/src/main/java/org/owasp/webgoat/path_traversal/ProfileUploadBase.java#L26">execute()</a> que se encarga de almacenar el archivo al directorio <code class="language-plaintext highlighter-rouge">"/PathTraversal/" + webSession.getUserName()</code>, por lo cual, al inyectar el payload en <code class="language-plaintext highlighter-rouge">fullName</code> se logra activar la vulnerabilidad sin ninguna restricción.</p><h1 id="path-traversal---3">Path Traversal - #3</h1><p>El problema nos indica que el desarrollador ha solucionado la vulnerabilidad, por lo que debemos encontrar otro vector para explotarla. De nuevo revisamos los datos enviados y recibidos.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/02_paquete_inicial.png" alt="Respuesta Inicial" /> <em>Respuesta Inicial</em></p><p>Un punto importante es que ahora la funcionalidad que se consume es <code class="language-plaintext highlighter-rouge">/profile-upload-fix</code>, y la primera prueba a intentar es replicar la vulnerabilidad anterior, para verificar si ha sido mitigada.</p><p>Ahora que sabemos que ha sido mitigada, nos planteamos varios escenarios o soluciones que se pudieron implementar:</p><ul><li><strong>Una fijación de directorio.</strong><li><strong>Un filtrado de caracteres.</strong><li><strong>Un cambio de nombre del archivo final, por uno aleatorio o estatico.</strong></ul><p>Existen varias opciones, unas más seguras que otras. Pero recordemos el enunciado del problema y la <strong>literalidad y falta de contexto</strong> con que se le indica un error a un desarrollador; En muchos casos si me piden solucionar un fallo <code class="language-plaintext highlighter-rouge">X</code> no hay tiempo para pensar en <code class="language-plaintext highlighter-rouge">XY</code> o <code class="language-plaintext highlighter-rouge">XZ</code>, es por esto que al aplicar una mitigación sin un conocimiento general o técnico de la vulnerabilidad se puede incurrir en la creación de una brecha nueva.</p><blockquote><p>Si me piden eliminar los caracteres <code class="language-plaintext highlighter-rouge">../</code>, yo lo hago. &gt; Desarrollador, 2021 :v</p></blockquote><p>Imaginemos que una de las opciones para la eliminación es utilizar una funcionalidad de <code class="language-plaintext highlighter-rouge">replace("../", "")</code> en donde no hay cabida para los caracteres que explotan la vulnerabilidad inicial, sin embargo, no se consideraron la inyección de payload <strong>ofuscados</strong> o <strong>pre-construidos</strong>, como el siguiente ejemplo:</p><ul><li>..<code class="language-plaintext highlighter-rouge">../</code>/</ul><p>Si inyectamos la cadena anterior, el filtro solo detectará y reemplazará la parte central donde encuentra el patrón, no obstante, al eliminarlo o reemplazarlo por <strong>vacio ““</strong>, la unión de la cadena restante dará como resultado nuevamente en el <strong>payload malicioso</strong>.</p><ul><li>Payload pre-construido: ..<code class="language-plaintext highlighter-rouge">../</code>/..<code class="language-plaintext highlighter-rouge">../</code>/etc/passwd<li>Payload final: <code class="language-plaintext highlighter-rouge">../../etc/passwd</code></ul><p>Pongamoslo en practica:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/02_vulnerabilidad_pasada.png" alt="Reto Superado" /> <em>Reto Superado</em></p><p>La utilización de funcionalidades de <code class="language-plaintext highlighter-rouge">replace</code> se es susceptible a estos comportamientos en que se <strong>inyectan payload’s pre-construidos</strong>, ya que no es usual encontrar que estas funcionalidades se apliquen de forma iterativa hasta identificar que no estan los caracteres maliciosos. Ahora veamos el código fuente:</p><ul><li><a href="https://github.com/WebGoat/WebGoat/blob/develop/webgoat-lessons/path-traversal/src/main/java/org/owasp/webgoat/path_traversal/ProfileUploadFix.java"><strong>Código Path Traversal ProfileUploadFix</strong></a></ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/PathTraversal/profile-upload-fix"</span><span class="o">,</span> <span class="n">consumes</span> <span class="o">=</span> <span class="no">ALL_VALUE</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="no">APPLICATION_JSON_VALUE</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">AttackResult</span> <span class="nf">uploadFileHandler</span><span class="o">(</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"uploadedFileFix"</span><span class="o">)</span> <span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">,</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"fullNameFix"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">fullName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">fullName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">fullName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"../"</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span> <span class="o">:</span> <span class="s">""</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>El código es bastante simple, se identifica el comportamiento que habiamos previsto en la línea #6 y se observa que únicamente es aplicado al parametro <code class="language-plaintext highlighter-rouge">fullName</code>.</p><h1 id="path-traversal---4">Path Traversal - #4</h1><p>La descripción del reto nos indica que el desarrollador esta aburrido con este error y como se da en el parametro <code class="language-plaintext highlighter-rouge">fullName</code>, decide no utilizarlo. (<strong>¿En principio, por qué lo usaba :c ?</strong>). Como es costumbre, debemos verificar sí en realidad se realizo la mitigación.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/03_paquete_inicial.png" alt="Paquete Inicial" /> <em>Paquete Inicial</em></p><p>Revisando la respuesta con detenimiento efectivamente ya no hace uso del dato inyectado en <code class="language-plaintext highlighter-rouge">fullName</code>, pero entonces <strong>¿De dónde saca el nombre de la imagen?</strong>.</p><ul><li>Vemos que el nombre con el que se guarda la imagen es el original del archivo.<li>Ahora el archivo es almacenado con extensión.<li>¿Hay algún filtro de tipo de archivo? ¿Podemos subir cualquier archivo?.</ul><p>En este reto se explota un error muy común en los aplicativos:</p><blockquote><p><strong>!Todo lo enviado por el cliente es manipulable y debe ser validado¡</strong></p></blockquote><p>Así que nuestro desarrollador cree que al utilizar directamente el nombre del archivo se mitiga la vulnerabilidad por que estos datos <strong>¿NO?</strong> pueden contener código malicioso o no pueden ser manipulados. Ya veremos.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/03_vulnerabilidad_pasada.png" alt="Reto Superado" /> <em>Reto Superado</em></p><p>Esta vez el payload va en el parametro a <code class="language-plaintext highlighter-rouge">uploadedFileRemoveUserInput</code> el cual transporta el cuerpo de la <strong>imagen/archivo</strong> que se intenta subir, así pues el aplicativo no aplica filtros sobre este parametro y lo inyecta a la ruta donde se almacenará, provocando el mismo comportamiento inseguro de antes.</p><p>Ahora veamos el código fuente:</p><ul><li><a href="https://github.com/WebGoat/WebGoat/blob/develop/webgoat-lessons/path-traversal/src/main/java/org/owasp/webgoat/path_traversal/ProfileUploadRemoveUserInput.java"><strong>Código Path Traversal ProfileUploadRemoveUserInput</strong></a></ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/PathTraversal/profile-upload-remove-user-input"</span><span class="o">,</span> <span class="n">consumes</span> <span class="o">=</span> <span class="no">ALL_VALUE</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="no">APPLICATION_JSON_VALUE</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">AttackResult</span> <span class="nf">uploadFileHandler</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"uploadedFileRemoveUserInput"</span><span class="o">)</span> <span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Efectivamente el aplicativo realiza la lectura del nombre del archivo directamente de las propiedades del objeto <code class="language-plaintext highlighter-rouge">file</code> y, lo ejecuta sin validación o filtrado, por lo que es vulnerable.</p><h1 id="path-traversal---5">Path Traversal - #5</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/04_ejercicio_5.png" alt="Ejercicio #5" /> <em>Ejercicio #5</em></p><p>Este nuevo reto nos indica que debemos leer el archivo <code class="language-plaintext highlighter-rouge">path-traversal-secret.jpg</code>, pero aparentemente no contamos con ninguna funcionalidad ni formulario en el cual inyectar el ataque, solo tenemos gaticos tiernos. Aunque en el paquete enviado no aparecen parametros que podamos inyectar, se identifica algo “raro” en las cabeceras de respuesta:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/04_paquete_inicial.png" alt="Paquete Inicial" /> <em>Paquete Inicial</em></p><p>Vemos que la cabecera <code class="language-plaintext highlighter-rouge">location</code> contiene información del uso de un parametro <code class="language-plaintext highlighter-rouge">id</code> en la funcionalidad, así que presumimos se puede usar para realizar nuestro ataque, pero tenemos los siguientes inconvenientes:</p><ul><li>Al utilizar los caracteres <code class="language-plaintext highlighter-rouge">..</code> y <code class="language-plaintext highlighter-rouge">/</code> nos retorna un mensaje de error indicando que <strong>son caracteres no validos</strong>.</ul><p>Nuestro desarrollador a tomado medidas y ahora filtra los caracteres corruptos por separado. Entonces <strong>¿Cómo podemos evadir el filtro si ambos caracteres estan betados?</strong></p><p>Vamos a utilizar una técnicas de <strong>cambio de codificación</strong>, en la que enviamos el mismo contenido pero en una presentación distinta y así evitamos que el filtro detecte los caracteres que intentamos inyectar.</p><ul><li><code class="language-plaintext highlighter-rouge">../</code><li><code class="language-plaintext highlighter-rouge">%2e%2e%2f</code></ul><p>Para este caso los payloads anteriores son equivalentes ya que representan lo mismo, el primero se encuentra en <strong>representación ASCII</strong> habitual y, el segundo esta <strong>codificado en URL</strong>; La diferencia es que la <strong>presentación en URL</strong> no contiene los caracteres invalidos que nos indica la aplicación y nos permitirá realizar el ataque.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/04_primera_inyeccion.png" alt="Primera Inyeccion de Payload" /> <em>Primera Inyeccion de Payload</em></p><p>Vemos un comportamiento distinto que nos lista el contenido del directorio <code class="language-plaintext highlighter-rouge">../</code>, así que debemos buscar el archivo <code class="language-plaintext highlighter-rouge">path-traversal-secret.jpg</code> e intentamos acceder a más subdirectorios.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A1/3_path_traversal/04_payload_final.png" alt="Reto Superado" /> <em>Reto Superado</em></p><ul><li><code class="language-plaintext highlighter-rouge">id = ../../ path-traversal-secret</code><li><code class="language-plaintext highlighter-rouge">id = %2e%2e%2f%2e%2e%2fpath-traversal-secret</code></ul><p>Seguimos escalando directorios hasta encontrar el archivo objetivo. En este punto el desarrollador no tuvo en cuenta que existen otras formas de representación o codificación que son compatibles con funcionalidades internas y se interpretan igual.</p><p>Ahora veamos el código fuente:</p><ul><li><a href="https://github.com/WebGoat/WebGoat/blob/develop/webgoat-lessons/path-traversal/src/main/java/org/owasp/webgoat/path_traversal/ProfileUploadRetrieval.java"><strong>Código Path Traversal ProfileUploadRemoveUserInput</strong></a></ul><p>Condición de filtrado, que retorna un error si detecta por separado <code class="language-plaintext highlighter-rouge">..</code> o <code class="language-plaintext highlighter-rouge">/</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">(</span><span class="n">queryParams</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">queryParams</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">".."</span><span class="o">)</span> <span class="o">||</span> <span class="n">queryParams</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"/"</span><span class="o">)))</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">badRequest</span><span class="o">().</span><span class="na">body</span><span class="o">(</span><span class="s">"Illegal characters are not allowed in the query params"</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Una vez de pasa la condición anterior, se procede a enviar el valor del parametro <code class="language-plaintext highlighter-rouge">id</code> a la funcionalidad que crea el archivo:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">var</span> <span class="n">id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">catPicture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">catPicturesDirectory</span><span class="o">,</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nc">RandomUtils</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">11</span><span class="o">)</span> <span class="o">:</span> <span class="n">id</span><span class="o">)</span> <span class="o">+</span> <span class="s">".jpg"</span><span class="o">);</span>
</pre></table></code></div></div><h1 id="referencias">Referencias</h1><ol><li><a href="http://www.w3bai.com/es/tags/ref_urlencode.html">Codificación URL</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/webgoat/'>WebGoat</a>, <a href='/categories/a1/'>A1</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pathtraversal/" class="post-tag no-text-decoration" >PathTraversal</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=WebGoat - A1 - Path Traversal - CSL&url=https://csl-labs.github.io/posts/webgoat-a1-path-traversal/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=WebGoat - A1 - Path Traversal - CSL&u=https://csl-labs.github.io/posts/webgoat-a1-path-traversal/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=WebGoat - A1 - Path Traversal - CSL&url=https://csl-labs.github.io/posts/webgoat-a1-path-traversal/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Actualizada Recientemente</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htb-nest/">HTB-NEST</a><li><a href="/posts/htb-openadmin/">HTB-OPENADMIN</a><li><a href="/posts/htb-sauna/">HTB-SAUNA</a></ul></div><div id="access-tags"> <span>Tags Relevantes</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/ad/">AD</a> <a class="post-tag" href="/tags/blind-sql/">blind sql</a> <a class="post-tag" href="/tags/cracking/">cracking</a> <a class="post-tag" href="/tags/decompiling/">decompiling</a> <a class="post-tag" href="/tags/journalctl/">journalctl</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/nodejs/">NodeJS</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Tabla de Contenido</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Otras Publicaciones</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/webgoat-a1-sql-injection/"><div class="card-body"> <span class="timeago small" > Mar 10 <i class="unloaded">2021-03-10T14:10:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WebGoat - A1 - SQL Injection Advanced</h3><div class="text-muted small"><p> Introducción En esta ocasión vamos a trabajar con un laboratorio de SQL Injection - Advanced, en el que realizaremos 2 tipos de ataque SQL injection interesantes y de nivel medio, como lo son: S...</p></div></div></a></div><div class="card"> <a href="/posts/webgoat-a7-xss/"><div class="card-body"> <span class="timeago small" > Mar 1 <i class="unloaded">2021-03-01T14:10:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WebGoat - A7 - (XSS) Cross Site Scripting</h3><div class="text-muted small"><p> Introducción En esta ocasión vamos a trabajar con un laboratorio de Cross Site Scripting (XSS), en el que nos aprovecharemos de distintas funcionalidades que no realizan un correcto saneamiento de ...</p></div></div></a></div><div class="card"> <a href="/posts/htb-nest/"><div class="card-body"> <span class="timeago small" > Nov 26, 2020 <i class="unloaded">2020-11-26T14:10:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB-NEST</h3><div class="text-muted small"><p> Decripción del entorno Atacante OS Kali Linux IP 10.10.14.199 Maquina Objetivo OS Windows IP 10.10....</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/htb-nest/" class="btn btn-outline-primary"><p>HTB-NEST</p></a> <a href="/posts/webgoat-a7-xss/" class="btn btn-outline-primary"><p>WebGoat - A7 - (XSS) Cross Site Scripting</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/CsLcol">CSL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Tags Relevantes</h4><a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/ad/">AD</a> <a class="post-tag" href="/tags/blind-sql/">blind sql</a> <a class="post-tag" href="/tags/cracking/">cracking</a> <a class="post-tag" href="/tags/decompiling/">decompiling</a> <a class="post-tag" href="/tags/journalctl/">journalctl</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/nodejs/">NodeJS</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://csl-labs.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); </script>
